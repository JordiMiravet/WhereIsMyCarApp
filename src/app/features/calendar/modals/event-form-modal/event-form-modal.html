<section 
  class="modal-overlay" 
  (click)="handleClose()"
  role="dialog"
  aria-modal="true"
  aria-labelledby="eventFormTitle"
>
    <form 
        [formGroup]="formEvent" 
        (ngSubmit)="onSubmit()" 
        (click)="$event.stopPropagation()"
        class="event-form"
        novalidate
    >

        <fieldset class="event-form__fieldset">
            <legend id="eventFormTitle" class="event-form__legend">
                <i class="pi pi-calendar" aria-hidden="true"></i> 
                Add new Event
            </legend>

            <div class="event-form__group">
                <label class="event-form__label" for="inputEventTitle">Title *</label>
                <input 
                    class="event-form__input" 
                    type="text" 
                    formControlName="title" 
                    id="inputEventTitle" 
                    placeholder="Event Name*"
                    [ngClass]="{'event-form__input-error': formEvent.get('title')?.invalid && formEvent.get('title')?.touched}"
                    [attr.aria-invalid]="formEvent.get('title')?.invalid && formEvent.get('title')?.touched"
                    aria-describedby="titleError"
                    aria-required="true"
                >
                <p 
                    id="titleError"
                    class="event-form__error" 
                    role="alert"
                    [hidden]="formEvent.get('title')?.valid || !formEvent.get('title')?.touched"
                >
                    <i class="pi pi-exclamation-circle" aria-hidden="true"></i> 
                    This field is required
                </p>
            </div>

            <div class="event-form__group">
                <label class="event-form__label" for="inputEventDate">Date *</label>
                <input 
                    class="event-form__input" 
                    type="date" 
                    formControlName="date" 
                    id="inputEventDate"
                    [ngClass]="{'event-form__input-error': formEvent.get('date')?.invalid && formEvent.get('date')?.touched}"
                    [attr.aria-invalid]="formEvent.get('date')?.invalid && formEvent.get('date')?.touched"
                    aria-describedby="dateError"
                    aria-required="true"
                >

                <p 
                    id="dateError"
                    class="event-form__error" 
                    role="alert"
                    [hidden]="formEvent.get('date')?.valid || !formEvent.get('date')?.touched"
                >
                    <i class="pi pi-exclamation-circle" aria-hidden="true"></i>
                    This field is required
                </p>
            </div>

            <div class="event-form__time-group">
                <div class="event-form__group">
                    <label class="event-form__label" for="inputEventHourStart">Start Time *</label>
                    <input 
                        class="event-form__input" 
                        type="time" 
                        formControlName="hourStart" 
                        id="inputEventHourStart"
                        [ngClass]="{'event-form__input-error': formEvent.get('hourStart')?.invalid && formEvent.get('hourStart')?.touched}"
                        [attr.aria-invalid]="formEvent.get('hourStart')?.invalid && formEvent.get('hourStart')?.touched"
                        aria-describedby="hourStartError invalidRangeError overlapError"
                        aria-required="true"
                    >
                    <p 
                        id="hourStartError"
                        class="event-form__error" 
                        role="alert"
                        [hidden]="formEvent.get('hourStart')?.valid || !formEvent.get('hourStart')?.touched"
                    >
                        <i class="pi pi-exclamation-circle" aria-hidden="true"></i>
                        This field is required
                    </p>
                </div>

                <div class="event-form__group">
                    <label class="event-form__label" for="inputEventHourEnd">End Time *</label>
                    <input 
                        class="event-form__input" 
                        type="time" 
                        formControlName="hourEnd" 
                        id="inputEventHourEnd"
                        [ngClass]="{'event-form__input-error': formEvent.get('hourEnd')?.invalid && formEvent.get('hourEnd')?.touched}"
                        [attr.aria-invalid]="formEvent.get('hourEnd')?.invalid && formEvent.get('hourEnd')?.touched"
                        aria-describedby="hourEndError invalidRangeError overlapError"
                        aria-required="true"
                    >
                    <p 
                        id="hourEndError"
                        class="event-form__error" 
                        role="alert"
                        [hidden]="formEvent.get('hourEnd')?.valid || !formEvent.get('hourEnd')?.touched"
                    >
                        <i class="pi pi-exclamation-circle" aria-hidden="true"></i>
                        This field is required
                    </p>
                </div>
                <p 
                    id="invalidRangeError"
                    class="event-form__error" 
                    role="alert"
                    [hidden]="!formEvent.hasError('invalidTimeRange') || !formEvent.get('hourStart')?.touched || !formEvent.get('hourEnd')?.touched"
                >
                    <i class="pi pi-exclamation-circle" aria-hidden="true"></i> 
                    Are you going back to the future, McFly? End time must be after start time                
                </p>
                <p 
                    id="overlapError"
                    class="event-form__error" 
                    role="alert"
                    [hidden]="!formEvent.hasError('timeOverlap') || formEvent.hasError('invalidTimeRange')"
                >
                    <i class="pi pi-exclamation-circle" aria-hidden="true"></i>
                    This time slot overlaps with another event on the same day
                </p>
            </div>
            
            <div class="event-form__group">
                <label class="event-form__label" for="vehicleSelect">Vehicle *</label>
                <select
                    id="vehicleSelect"
                    class="event-form__input"
                    formControlName="vehicleId"
                    [ngClass]="{'event-form__input-error': formEvent.get('vehicleId')?.invalid && formEvent.get('vehicleId')?.touched}"
                    [attr.aria-invalid]="formEvent.get('vehicleId')?.invalid && formEvent.get('vehicleId')?.touched"
                    aria-describedby="vehicleError"
                    aria-required="true"
                >
                    <option value="" hidden>Select vehicle*</option>
                    @for (vehicle of vehicles(); track vehicle._id) {
                        <option [value]="vehicle._id">
                            {{ vehicle.name }}
                        </option>
                    }
                </select>

                <p
                    class="event-form__error"
                    role="alert"
                    [hidden]="formEvent.get('vehicleId')?.valid || !formEvent.get('vehicleId')?.touched"
                >
                    <i class="pi pi-exclamation-circle"></i>
                    Please select a vehicle
                </p>
            </div>
            <div class="event-form__group">
                <label class="event-form__label" for="inputEventComment">Comment</label>
                <textarea 
                    formControlName="comment" 
                    id="inputEventComment" 
                    class="event-form__textarea"
                    placeholder="Type the note here..."
                    rows="4"
                ></textarea>
            </div>

            <div class="event-form__actions">
                <button 
                    class="event-form__button event-form__button--Cancel" 
                    type="button" 
                    (click)="handleClose()" 
                    aria-label="Cancel adding event"
                >
                    Cancel
                </button>

                <button 
                    class="event-form__button event-form__button--Save" 
                    type="submit" 
                    [disabled]="formEvent.invalid"
                    aria-label="Save event"
                >
                    <i class="pi pi-save" aria-hidden="true"></i>
                    Save
                </button>
            </div>
        </fieldset>

        <p class="event-form__note">
            <i class="pi pi-exclamation-circle" aria-hidden="true"></i>
            Fields marked with * are required
        </p>

    </form>
</section>
